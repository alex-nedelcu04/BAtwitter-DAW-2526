@page
@model RegisterModel
@{
    ViewData["Title"] = "Register";
}

<h1>@ViewData["Title"]</h1>


<div class="md-4">
    <form id="registerForm" enctype="multipart/form-data" asp-route-returnUrl="@Model.ReturnUrl" method="post">
        <hr />
        <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>
        <div class="form-floating mb-3">
            <input asp-for="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="name@example.com" />
            <label asp-for="Input.Email">Email</label>
            <span asp-validation-for="Input.Email" class="text-danger"></span>
        </div>
        <div class="form-floating mb-3">
            <input asp-for="Input.UserName" class="form-control" autocomplete="username" aria-required="true" placeholder="username" />
            <label asp-for="Input.UserName">Username</label>
            <span asp-validation-for="Input.UserName" class="text-danger"></span>
        </div>
        <div class="form-floating mb-3">
            <input asp-for="Input.DisplayName" class="form-control" aria-required="true" placeholder="Display Name" />
            <label asp-for="Input.DisplayName">Display Name</label>
            <span asp-validation-for="Input.DisplayName" class="text-danger"></span>
        </div>
        <div class="form-floating mb-3">
            <textarea asp-for="Input.Description" class="form-control" maxlength="150" placeholder="Description (optional)"></textarea>
            <label asp-for="Input.Description">Description (max 150 characters, optional)</label>
            <span asp-validation-for="Input.Description" class="text-danger"></span>
        </div>
        <div class="form-floating mb-3">
            <input asp-for="Input.Pronouns" class="form-control" placeholder="Pronouns (optional)" />
            <label asp-for="Input.Pronouns">Pronouns (optional)</label>
            <span asp-validation-for="Input.Pronouns" class="text-danger"></span>
        </div>

        <hr />
        <!-- Profile Picture Section -->
        <div class="mb-3">
            <label class="form-label">Profile Picture</label>
            <button type="button" id="addPfpBtn" title="Add profile picture" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-person-circle"></i> Add Profile Picture
            </button>
            <small class="text-muted mt-1 d-block" style="font-size: 12px !important; font-style: oblique !important">
                Accepted formats: jpg, jpeg, png, webp.
            </small>
            <span asp-validation-for="Input.PfpLink" class="text-danger d-block"></span>
        </div>

        <input id="pfp" name="pfp" type="file" class="d-none" accept="image/*" />
        <input type="hidden" asp-for="Input.PfpLink" id="pfpLinkHidden" />

        <!-- Preview for Profile Picture -->
        <div id="pfpPreviewContainer" class="mb-4"></div>

        <!-- Banner Section -->
        <div class="mb-3">
            <label class="form-label">Banner</label>
            <button type="button" id="addBannerBtn" title="Add banner" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-image"></i> Add Banner
            </button>
            <small class="text-muted mt-1 d-block" style="font-size: 12px !important; font-style: oblique !important">
                Accepted formats: jpg, jpeg, png, webp.
            </small>
            <span asp-validation-for="Input.BannerLink" class="text-danger d-block"></span>
        </div>

        <input id="banner" name="banner" type="file" class="d-none" accept="image/*" />
        <input type="hidden" asp-for="Input.BannerLink" id="bannerLinkHidden" />

        <!-- Preview for Banner -->
        <div id="bannerPreviewContainer" class="mb-4"></div>


        <hr />
        <div class="form-floating mb-3">
            <input asp-for="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
            <label asp-for="Input.Password">Password</label>
            <span asp-validation-for="Input.Password" class="text-danger"></span>
        </div>
        <div class="form-floating mb-3">
            <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="password" />
            <label asp-for="Input.ConfirmPassword">Confirm Password</label>
            <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
        </div>


        <button id="registerSubmit" type="submit" class="w-100 btn btn-lg btn-primary">Register</button>
    </form>

        
</div>



@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Profile Picture Preview
        const pfpInput = document.getElementById('pfp');
        const pfpPreviewContainer = document.getElementById('pfpPreviewContainer');
        const addPfpBtn = document.getElementById('addPfpBtn');
        const pfpLinkHidden = document.getElementById('pfpLinkHidden');

        addPfpBtn.addEventListener('click', () => {
            pfpInput.click();
        });

        pfpInput.addEventListener('change', () => handlePfpChange());

        function handlePfpChange() {
            // Clear existing preview
            pfpPreviewContainer.innerHTML = '';
            // Clear hidden field when new file is selected
            if (pfpLinkHidden) {
                pfpLinkHidden.value = '';
            }

            if (!pfpInput.files || pfpInput.files.length === 0) {
                return;
            }

            const file = pfpInput.files[0];

            const previewCard = document.createElement('div');
            previewCard.className = 'position-relative border rounded-3 p-2';
            previewCard.style.width = '200px';
            previewCard.style.height = '200px';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'btn btn-sm btn-light position-absolute';
            removeBtn.style.top = '8px';
            removeBtn.style.right = '8px';
            removeBtn.style.zIndex = '10';
            removeBtn.addEventListener('click', () => {
                pfpInput.value = '';
                pfpLinkHidden.value = '';
                previewCard.remove();
            });

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.onload = () => URL.revokeObjectURL(img.src);
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.classList.add('rounded-circle');

            previewCard.appendChild(removeBtn);
            previewCard.appendChild(img);
            pfpPreviewContainer.appendChild(previewCard);
        }

        // Restore preview from temp file on page load
        function restorePfpPreview() {
            const tempPath = pfpLinkHidden?.value;
            if (tempPath && tempPath.startsWith('/Resources/TempUploads/')) {
                const previewCard = document.createElement('div');
                previewCard.className = 'position-relative border rounded-3 p-2';
                previewCard.style.width = '200px';
                previewCard.style.height = '200px';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'btn btn-sm btn-light position-absolute';
                removeBtn.style.top = '8px';
                removeBtn.style.right = '8px';
                removeBtn.style.zIndex = '10';
                removeBtn.addEventListener('click', () => {
                    pfpInput.value = '';
                    pfpLinkHidden.value = '';
                    previewCard.remove();
                });

                const img = document.createElement('img');
                img.src = tempPath;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.classList.add('rounded-circle');

                previewCard.appendChild(removeBtn);
                previewCard.appendChild(img);
                pfpPreviewContainer.appendChild(previewCard);
            }
        }

        // Restore preview on page load
        document.addEventListener('DOMContentLoaded', restorePfpPreview);

        // Banner Preview
        const bannerInput = document.getElementById('banner');
        const bannerPreviewContainer = document.getElementById('bannerPreviewContainer');
        const addBannerBtn = document.getElementById('addBannerBtn');
        const bannerLinkHidden = document.getElementById('bannerLinkHidden');

        addBannerBtn.addEventListener('click', () => {
            bannerInput.click();
        });

        bannerInput.addEventListener('change', () => handleBannerChange());

        function handleBannerChange() {
            // Clear existing preview
            bannerPreviewContainer.innerHTML = '';
            // Clear hidden field when new file is selected
            if (bannerLinkHidden) {
                bannerLinkHidden.value = '';
            }

            if (!bannerInput.files || bannerInput.files.length === 0) {
                return;
            }

            const file = bannerInput.files[0];

            const previewCard = document.createElement('div');
            previewCard.className = 'position-relative border rounded-3 p-1';
            previewCard.style.width = '100%';
            previewCard.style.height = '200px';
            previewCard.style.maxWidth = '600px';

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'btn btn-sm btn-light position-absolute';
            removeBtn.style.top = '8px';
            removeBtn.style.right = '8px';
            removeBtn.style.zIndex = '10';
            removeBtn.addEventListener('click', () => {
                bannerInput.value = '';
                bannerLinkHidden.value = '';
                previewCard.remove();
            });

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.onload = () => URL.revokeObjectURL(img.src);
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.classList.add('rounded-2');

            previewCard.appendChild(removeBtn);
            previewCard.appendChild(img);
            bannerPreviewContainer.appendChild(previewCard);
        }

        // Restore preview from temp file on page load
        function restoreBannerPreview() {
            const tempPath = bannerLinkHidden?.value;
            if (tempPath && tempPath.startsWith('/Resources/TempUploads/')) {
                const previewCard = document.createElement('div');
                previewCard.className = 'position-relative border rounded-3 p-1';
                previewCard.style.width = '100%';
                previewCard.style.height = '200px';
                previewCard.style.maxWidth = '600px';

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'btn btn-sm btn-light position-absolute';
                removeBtn.style.top = '8px';
                removeBtn.style.right = '8px';
                removeBtn.style.zIndex = '10';
                removeBtn.addEventListener('click', () => {
                    bannerInput.value = '';
                    bannerLinkHidden.value = '';
                    previewCard.remove();
                });

                const img = document.createElement('img');
                img.src = tempPath;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.classList.add('rounded-2');

                previewCard.appendChild(removeBtn);
                previewCard.appendChild(img);
                bannerPreviewContainer.appendChild(previewCard);
            }
        }

        // Restore preview on page load
        document.addEventListener('DOMContentLoaded', restoreBannerPreview);
    </script>
}