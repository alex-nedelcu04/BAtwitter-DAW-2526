@using Microsoft.AspNetCore.Identity
@using BAtwitter_DAW_2526.Data
@using Microsoft.EntityFrameworkCore
@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext DbContext

@{
    var currentUserId = UserManager.GetUserId(User);
    var currentUser = !string.IsNullOrEmpty(currentUserId) ? DbContext.Users.Find(currentUserId) : null;

    var userProfile = currentUser != null
        ? DbContext.UserProfiles
            .Include(up => up.ApplicationUser)
            .FirstOrDefault(up => up.Id == currentUser.Id)
        : null;

    var displayname = userProfile?.DisplayName ?? "Unknown user";
    var username = currentUser?.UserName ?? User.Identity?.Name ?? "unknown";
    var pfpLink = userProfile?.PfpLink ?? "/Resources/Images/user_default_pfp.jpg";
    bool showLock = string.Equals(userProfile?.AccountStatus, "private");
}

<ul class="nav flex-column gap-1 m-0 p-0">
    @if (SignInManager.IsSignedIn(User))
    {
        <li class="nav-item">
            <div class="d-flex align-items-center">
                <!-- LEFT: profile link -->
                <a class="nav-link rounded-3 px-2 py-2 link-body-emphasis d-flex align-items-center flex-grow-1 profile-link"
                   asp-controller="UserProfiles"
                   asp-action="Show"
                   asp-route-username="@username"
                   title="View Profile"
                   style="min-width:0;">
                    <img src="@pfpLink"
                         alt="Profile Picture"
                         class="rounded-circle me-2 flex-shrink-0"
                         style="width: 32px; height: 32px; object-fit: cover;" />

                    <div class="d-flex flex-column" style="min-width:0;">
                        <div class="d-flex align-items-center gap-1" style="min-width:0;">
                            @if (showLock)
                            {
                                <span class="fw-semibold text-truncate" style="max-width: 80px;">
                                    @displayname
                                </span>
                                <i class="bi bi-lock-fill fs-6"></i>

                            }
                            else
                            {
                                <span class="fw-semibold text-truncate" style="max-width: 100px;">
                                    @displayname
                                </span>
                            }
                        </div>

                        <!-- ✅ username truncate -->
                        <small class="text-muted text-truncate d-block" style="max-width: 100px;">
                            @($"@{username}")
                        </small>
                    </div>
                </a>

                <!-- RIGHT: arrow dropup -->
                <div class="dropup">
                    <button type="button"
                            class="btn btn-link nav-link px-2 py-2 link-body-emphasis profile-dropup-arrow"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                            aria-label="Open profile menu">
                        <i class="bi bi-chevron-up"></i>
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item"
                               asp-controller="UserProfiles"
                               asp-action="Show"
                               asp-route-username="@username">
                                <i class="bi bi-person me-2"></i>View profile
                            </a>
                        </li>

                        <li>
                            <a class="dropdown-item"
                               asp-area="Identity"
                               asp-page="/Account/Manage/Index">
                                <i class="bi bi-gear me-2"></i>Settings
                            </a>
                        </li>

                        <li><hr class="dropdown-divider" /></li>

                        <li>
                            <form asp-area="Identity"
                                  asp-page="/Account/Logout"
                                  asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })"
                                  class="m-0">
                                <button type="submit" class="dropdown-item">
                                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                                </button>
                            </form>
                        </li>
                    </ul>

                </div>
            </div>

        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="nav-link rounded-3 px-2 py-2 link-body-emphasis"
               asp-area="Identity" asp-page="/Account/Register">
                <i class="bi bi-person-plus me-2"></i>Register
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link rounded-3 px-2 py-2 link-body-emphasis"
               asp-area="Identity" asp-page="/Account/Login">
                <i class="bi bi-box-arrow-in-right me-2"></i>Login
            </a>
        </li>
    }
</ul>
